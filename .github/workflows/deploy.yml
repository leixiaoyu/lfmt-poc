name: Deploy LFMT Infrastructure

# Automated CI/CD pipeline with secure OIDC authentication
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'shared-types/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/functions/package-lock.json

      - name: Install shared-types dependencies
        working-directory: shared-types
        run: npm install

      - name: Install function dependencies
        working-directory: backend/functions
        run: npm ci

      - name: Run function tests
        working-directory: backend/functions
        run: npm test

      - name: Check test coverage
        working-directory: backend/functions
        run: npm run test:coverage

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install shared-types dependencies
        working-directory: shared-types
        run: npm install

      - name: Build shared-types
        working-directory: shared-types
        run: npm run build

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: npm test -- --run

      - name: Build frontend (production)
        working-directory: frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [test, build-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: development
      url: https://d1yysvwo9eg20b.cloudfront.net
    outputs:
      api_url: ${{ steps.get-url.outputs.api_url }}
      frontend_url: ${{ steps.get-frontend-url.outputs.frontend_url }}

    permissions:
      id-token: write   # Required for OIDC authentication
      contents: read    # Required to checkout code

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/infrastructure/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-LFMT-Deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Install shared-types dependencies
        working-directory: shared-types
        run: npm ci

      - name: Install function dependencies
        working-directory: backend/functions
        run: npm ci

      - name: Install infrastructure dependencies
        working-directory: backend/infrastructure
        run: npm ci

      - name: CDK Bootstrap (if needed)
        working-directory: backend/infrastructure
        run: |
          if ! aws cloudformation describe-stacks --stack-name CDKToolkit --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "CDKToolkit not found, bootstrapping..."
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            npx cdk bootstrap aws://${ACCOUNT_ID}/${{ env.AWS_REGION }}
          else
            echo "CDKToolkit already exists, skipping bootstrap"
          fi

      - name: CDK Deploy to Dev
        working-directory: backend/infrastructure
        run: npx cdk deploy --context environment=dev --require-approval never

      - name: Get API URL
        id: get-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name LfmtPocDev \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"

      - name: Test API Health
        run: |
          curl -f ${{ steps.get-url.outputs.api_url }}/v1/auth || echo "API not yet ready, may need warm-up"

      - name: Download frontend build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Create frontend .env.production
        working-directory: frontend
        run: |
          echo "VITE_API_URL=${{ steps.get-url.outputs.api_url }}" > .env.production
          cat .env.production

      - name: Deploy frontend to S3
        run: |
          aws s3 sync frontend/dist/ s3://lfmt-poc-frontend/ --delete --cache-control "public, max-age=31536000, immutable" --exclude "index.html"
          aws s3 cp frontend/dist/index.html s3://lfmt-poc-frontend/index.html --cache-control "public, max-age=0, must-revalidate"

      - name: Get CloudFront Distribution ID
        id: get-cf-dist
        run: |
          DIST_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Origins.Items[0].DomainName=='lfmt-poc-frontend.s3.amazonaws.com'].Id | [0]" --output text)
          echo "distribution_id=$DIST_ID" >> $GITHUB_OUTPUT
          echo "CloudFront Distribution ID: $DIST_ID"

      - name: Get CloudFront URL
        id: get-frontend-url
        run: |
          FRONTEND_URL=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[0].DomainName=='lfmt-poc-frontend.s3.amazonaws.com'].DomainName | [0]" \
            --output text)
          echo "frontend_url=https://${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "Frontend URL: https://${FRONTEND_URL}"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ steps.get-cf-dist.outputs.distribution_id }} --paths "/*"
          echo "CloudFront cache invalidation initiated"

      - name: Frontend Deployment Summary
        run: |
          echo "========================================="
          echo "Frontend Deployment Summary"
          echo "========================================="
          echo "S3 Bucket: lfmt-poc-frontend"
          echo "CloudFront Distribution: ${{ steps.get-cf-dist.outputs.distribution_id }}"
          echo "Frontend URL: ${{ steps.get-frontend-url.outputs.frontend_url }}"
          echo "API URL: ${{ steps.get-url.outputs.api_url }}"
          echo "========================================="

  integration-tests:
    name: Run Backend Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/functions/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-LFMT-Integration-Tests
          aws-region: ${{ env.AWS_REGION }}

      - name: Install shared-types dependencies
        working-directory: shared-types
        run: npm ci

      - name: Install function dependencies
        working-directory: backend/functions
        run: npm ci

      - name: Get API URL
        id: get-api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name LfmtPocDev \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "Using API URL: $API_URL"

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API to be ready..."
          for i in {1..30}; do
            if curl -sf ${{ steps.get-api-url.outputs.api_url }}/v1/auth/me > /dev/null 2>&1; then
              echo "API is ready!"
              exit 0
            fi
            echo "Attempt $i/30: API not ready yet, waiting 10 seconds..."
            sleep 10
          done
          echo "Warning: API may not be fully ready, proceeding with tests anyway"
        continue-on-error: true

      - name: Run Health Check Integration Tests
        working-directory: backend/functions
        run: npm run test:integration -- health-check.integration.test.ts
        env:
          API_BASE_URL: ${{ steps.get-api-url.outputs.api_url }}/v1
        continue-on-error: true

      - name: Run API Integration Tests
        working-directory: backend/functions
        run: npm run test:integration -- api-integration.test.ts
        env:
          API_BASE_URL: ${{ steps.get-api-url.outputs.api_url }}/v1
        continue-on-error: true

      - name: Run Translation Flow Integration Tests
        working-directory: backend/functions
        run: npm run test:integration -- translation-flow.integration.test.ts --testTimeout=600000
        env:
          API_BASE_URL: ${{ steps.get-api-url.outputs.api_url }}/v1
          TEST_TIMEOUT: 600000
        continue-on-error: true

      - name: Backend Integration Test Summary
        if: always()
        run: |
          echo "========================================="
          echo "Backend Integration Test Summary"
          echo "========================================="
          echo "API URL: ${{ steps.get-api-url.outputs.api_url }}"
          echo "Tests completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="

  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Wait for frontend to be ready
        run: |
          echo "Waiting for frontend to be ready..."
          for i in {1..30}; do
            if curl -sf ${{ needs.deploy-dev.outputs.frontend_url }}/ > /dev/null 2>&1; then
              echo "Frontend is ready!"
              exit 0
            fi
            echo "Attempt $i/30: Frontend not ready yet, waiting 10 seconds..."
            sleep 10
          done
          echo "Proceeding with tests..."

      - name: Run E2E tests
        working-directory: frontend
        run: npm run test:e2e
        env:
          PLAYWRIGHT_BASE_URL: ${{ needs.deploy-dev.outputs.frontend_url }}
          API_BASE_URL: ${{ needs.deploy-dev.outputs.api_url }}
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: frontend/test-results/
          retention-days: 7

      - name: E2E Test Summary
        if: always()
        run: |
          echo "========================================="
          echo "E2E Test Summary"
          echo "========================================="
          echo "Frontend URL: ${{ needs.deploy-dev.outputs.frontend_url }}"
          echo "API URL: ${{ needs.deploy-dev.outputs.api_url }}"
          echo "Tests completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.lfmt.yourcompany.com

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-LFMT-Deploy-Staging
          aws-region: ${{ env.AWS_REGION }}

      - name: Install shared-types dependencies
        working-directory: shared-types
        run: npm ci

      - name: Install function dependencies
        working-directory: backend/functions
        run: npm ci

      - name: Install infrastructure dependencies
        working-directory: backend/infrastructure
        run: npm ci

      - name: CDK Deploy to Staging
        working-directory: backend/infrastructure
        run: npx cdk deploy --context environment=staging --require-approval never

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment:
      name: production
      url: https://lfmt.yourcompany.com

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-LFMT-Deploy-Prod
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          echo "Deploying to production with identity:"
          aws sts get-caller-identity

      - name: Install shared-types dependencies
        working-directory: shared-types
        run: npm ci

      - name: Install function dependencies
        working-directory: backend/functions
        run: npm ci

      - name: Install infrastructure dependencies
        working-directory: backend/infrastructure
        run: npm ci

      - name: CDK Bootstrap (if needed)
        working-directory: backend/infrastructure
        run: |
          if ! aws cloudformation describe-stacks --stack-name CDKToolkit --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "CDKToolkit not found, bootstrapping..."
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            npx cdk bootstrap aws://${ACCOUNT_ID}/${{ env.AWS_REGION }}
          else
            echo "CDKToolkit already exists, skipping bootstrap"
          fi

      - name: CDK Diff (show changes)
        working-directory: backend/infrastructure
        run: npx cdk diff --context environment=prod || true

      - name: CDK Deploy Main Infrastructure
        working-directory: backend/infrastructure
        run: npx cdk deploy LfmtPocProd --context environment=prod --require-approval never

      - name: Get API Gateway URL
        id: get-api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name LfmtPocProd \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "Production API URL: $API_URL"

      - name: Health Check
        run: |
          echo "Performing health check on production API..."
          curl -f ${{ steps.get-api-url.outputs.api_url }}/v1/health || echo "Health check endpoint not yet available"

      - name: Deployment Summary
        run: |
          echo "========================================="
          echo "Production Deployment Summary"
          echo "========================================="
          echo "Environment: production"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Stack: LfmtPocProd"
          echo "API URL: ${{ steps.get-api-url.outputs.api_url }}"
          echo "Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="
